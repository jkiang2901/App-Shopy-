<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo d√µi doanh thu</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1>Theo d√µi doanh thu</h1>
            <div class="nav-actions">
                <button onclick="window.location.href='dashboard.html'" class="btn btn-secondary">üè† V·ªÅ Dashboard</button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <!-- Revenue Controls -->
        <div class="revenue-controls" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: var(--shadow-md);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div class="filter-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569;">T·ª´ ng√†y:</label>
                    <input type="date" id="dayPicker" onchange="loadRevenue()" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="filter-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569;">ƒê·∫øn ng√†y:</label>
                    <input type="date" id="dayPickerEnd" onchange="loadRevenue()" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>
                <div class="filter-group" style="display: flex; align-items: flex-end; gap: 10px;">
                    <button onclick="loadRevenue()" class="btn btn-primary" style="flex: 1;">üîÑ T·∫£i l·∫°i</button>
                    <button onclick="showAllRevenue()" class="btn btn-secondary" style="flex: 1;">üìä T·∫•t c·∫£</button>
                </div>
            </div>
        </div>

            <!-- Revenue Summary Cards -->
        <div class="revenue-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div class="revenue-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow-lg);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üí∞ T·ªïng doanh thu</div>
                <div id="totalRevenue" style="font-size: 32px; font-weight: 700;">0 VNƒê</div>
                <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">(ƒê√£ ho√†n th√†nh)</div>
            </div>
            <div class="revenue-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: var(--shadow-lg);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">üì¶ T·ªïng ƒë∆°n h√†ng</div>
                <div id="totalOrders" style="font-size: 32px; font-weight: 700;">0</div>
                <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">(ƒê√£ ho√†n th√†nh)</div>
            </div>
        </div>

        <!-- Revenue Table -->
        <div class="table-container">
            <table id="revenueTable">
                <thead>
                    <tr>
                        <th>Ng√†y</th>
                        <th>S·ªë ƒë∆°n h√†ng</th>
                        <th>Doanh thu</th>
                        <th>Chi ti·∫øt</th>
                        <th>X√≥a</th>
                    </tr>
                </thead>
                <tbody id="revenueTableBody">
                    <tr><td colspan="5" class="loading">ƒêang t·∫£i...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Revenue Details Modal -->
    <div id="revenueDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeRevenueDetails()">&times;</span>
            <h2>Chi ti·∫øt ƒë∆°n h√†ng ƒë√£ b√°n</h2>
            <div id="revenueDetailsContent">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
    
    <!-- Delete Revenue Modal -->
    <div id="deleteRevenueModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDeleteRevenueModal()">&times;</span>
            <h2>üóëÔ∏è X√≥a doanh thu</h2>
            <div id="deleteRevenueInfo" style="background: var(--gray-100); padding: 15px; border-radius: 8px; margin: 15px 0;"></div>
            <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <p style="margin: 0; color: #991b1b; font-weight: 600;">‚ö†Ô∏è C·∫£nh b√°o:</p>
                <p style="margin: 5px 0 0 0; color: #7f1d1d;">X√≥a doanh thu s·∫Ω:</p>
                <ul style="margin: 5px 0 0 20px; color: #7f1d1d;">
                    <li>H·ªßy t·∫•t c·∫£ ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh trong k·ª≥ ƒë√£ ch·ªçn</li>
                    <li>Tr·∫£ l·∫°i s·ªë l∆∞·ª£ng s·∫£n ph·∫©m v√†o kho</li>
                    <li>Kh√¥ng th·ªÉ ho√†n t√°c h√†nh ƒë·ªông n√†y</li>
                </ul>
            </div>
            <div class="form-actions">
                <button type="button" onclick="closeDeleteRevenueModal()" class="btn btn-secondary">H·ªßy</button>
                <button type="button" onclick="confirmDeleteRevenue()" class="btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">üóëÔ∏è X√°c nh·∫≠n x√≥a</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Revenue by Date Modal -->
    <div id="deleteRevenueByDateModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDeleteRevenueByDateModal()">&times;</span>
            <h2>üóëÔ∏è X√≥a doanh thu theo ng√†y</h2>
            <div id="deleteRevenueByDateInfo" style="background: var(--gray-100); padding: 15px; border-radius: 8px; margin: 15px 0;"></div>
            <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <p style="margin: 0; color: #991b1b; font-weight: 600;">‚ö†Ô∏è C·∫£nh b√°o:</p>
                <p style="margin: 5px 0 0 0; color: #7f1d1d;">X√≥a doanh thu s·∫Ω:</p>
                <ul style="margin: 5px 0 0 20px; color: #7f1d1d;">
                    <li>H·ªßy t·∫•t c·∫£ ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh trong ng√†y n√†y</li>
                    <li>Tr·∫£ l·∫°i s·ªë l∆∞·ª£ng s·∫£n ph·∫©m v√†o kho</li>
                    <li>Kh√¥ng th·ªÉ ho√†n t√°c h√†nh ƒë·ªông n√†y</li>
                </ul>
            </div>
            <div class="form-actions">
                <button type="button" onclick="closeDeleteRevenueByDateModal()" class="btn btn-secondary">H·ªßy</button>
                <button type="button" onclick="confirmDeleteRevenueByDate()" class="btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">üóëÔ∏è X√°c nh·∫≠n x√≥a</button>
            </div>
        </div>
    </div>
    
    <script src="admin.js"></script>
    <script>
        checkAuth();
        
        // Initialize date pickers with current date
        const now = new Date();
        const today = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        document.getElementById('dayPicker').value = today;
        document.getElementById('dayPickerEnd').value = today;
        
        let currentRevenuePeriod = 'month';
        let ordersByDate = {}; // Store orders grouped by date
        
        // Format currency helper
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }
        
        // Set revenue period (kept for compatibility, but simplified)
        function setRevenuePeriod(period) {
            currentRevenuePeriod = period;
            const now = new Date();
            const dayPicker = document.getElementById('dayPicker');
            const dayPickerEnd = document.getElementById('dayPickerEnd');
            
            // Clear all pickers first
            dayPicker.value = '';
            dayPickerEnd.value = '';
            
            if (period === 'day') {
                const currentDay = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                dayPicker.value = currentDay;
                dayPickerEnd.value = currentDay;
            } else if (period === 'week') {
                // Set to start of current week (Monday)
                const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
                const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Days to subtract to get to Monday
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() + diff);
                const weekStartStr = weekStart.getFullYear() + '-' + String(weekStart.getMonth() + 1).padStart(2, '0') + '-' + String(weekStart.getDate()).padStart(2, '0');
                dayPicker.value = weekStartStr;
                
                // Set end date to Sunday (6 days later)
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                const weekEndStr = weekEnd.getFullYear() + '-' + String(weekEnd.getMonth() + 1).padStart(2, '0') + '-' + String(weekEnd.getDate()).padStart(2, '0');
                dayPickerEnd.value = weekEndStr;
            }
            loadRevenue();
        }
        
        // Show all revenue (clear date filters)
        function showAllRevenue() {
            const dayPicker = document.getElementById('dayPicker');
            const dayPickerEnd = document.getElementById('dayPickerEnd');
            
            // Clear all date pickers
            dayPicker.value = '';
            dayPickerEnd.value = '';
            
            // Load all revenue
            loadRevenue();
        }
        
        // Load revenue data
        async function loadRevenue() {
            const tbody = document.getElementById('revenueTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="loading">ƒêang t·∫£i...</td></tr>';
            
            // Update summary cards with loading state
            document.getElementById('totalRevenue').textContent = 'ƒêang t·∫£i...';
            document.getElementById('totalOrders').textContent = '...';
            
            const token = localStorage.getItem('adminToken');
            const dayPicker = document.getElementById('dayPicker');
            const dayPickerEnd = document.getElementById('dayPickerEnd');
            const params = new URLSearchParams();
            
            if (dayPicker.value) {
                params.append('day', dayPicker.value);
                if (dayPickerEnd.value) {
                    params.append('dayEnd', dayPickerEnd.value);
                }
            }
            
            try {
                // Try different possible API endpoints
                let url = `${API_BASE_URL}/api/revenue`;
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                let response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // If revenue endpoint doesn't exist, try orders endpoint
                if (response.status === 404) {
                    url = `${API_BASE_URL}/api/orders`;
                    if (params.toString()) {
                        url += '?' + params.toString();
                    }
                    response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                }
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu doanh thu');
                }
                
                const data = await response.json();
                processRevenueData(data);
            } catch (error) {
                console.error('Error loading revenue:', error);
                // Show mock data for demonstration
                displayMockRevenue();
            }
        }
        
        // Process revenue data from API
        function processRevenueData(data) {
            // Handle different response formats
            let orders = [];
            if (Array.isArray(data)) {
                orders = data;
            } else if (data.orders) {
                orders = data.orders;
            } else if (data.data) {
                orders = data.data;
            }
            
            // Filter orders for revenue calculation
            // Ch·ªâ t√≠nh doanh thu cho c√°c ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh (delivered)
            // Khi admin ho√†n th√†nh ƒë∆°n h√†ng (status = 'delivered'), ƒë∆°n h√†ng ƒë√≥ s·∫Ω ƒë∆∞·ª£c t√≠nh v√†o doanh thu
            const completedOrders = orders.filter(order => {
                const status = order.status || order.orderStatus || '';
                // Ch·ªâ t√≠nh c√°c ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh (delivered): Khi ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c giao th√†nh c√¥ng
                return status === 'delivered';
            });
            
            // Get filter values
            const dayPicker = document.getElementById('dayPicker');
            const dayPickerEnd = document.getElementById('dayPickerEnd');
            
            // Filter orders by date range
            let filteredOrders = completedOrders;
            
            if (dayPicker.value) {
                const startDate = new Date(dayPicker.value);
                startDate.setHours(0, 0, 0, 0); // Start of day
                
                let endDate;
                if (dayPickerEnd.value) {
                    endDate = new Date(dayPickerEnd.value);
                    endDate.setHours(23, 59, 59, 999); // End of day
                } else {
                    // If no end date, use start date as end date (single day)
                    endDate = new Date(startDate);
                    endDate.setHours(23, 59, 59, 999);
                }
                
                filteredOrders = completedOrders.filter(order => {
                    const status = order.status || order.orderStatus || '';
                    let orderDate;
                    if (status === 'delivered' && order.updatedAt) {
                        orderDate = new Date(order.updatedAt);
                    } else {
                        orderDate = new Date(order.createdAt || order.date || Date.now());
                    }
                    return orderDate >= startDate && orderDate <= endDate;
                });
            }
            
            // Calculate revenue statistics from filtered orders
            let totalRevenue = 0;
            let totalOrders = filteredOrders.length;
            const revenueByDate = {};
            ordersByDate = {}; // Reset orders by date
            
            filteredOrders.forEach(order => {
                const status = order.status || order.orderStatus || '';
                // V·ªõi ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh, ∆∞u ti√™n d√πng ng√†y c·∫≠p nh·∫≠t (ng√†y ho√†n th√†nh)
                // N·∫øu kh√¥ng c√≥ th√¨ d√πng ng√†y t·∫°o
                let orderDate;
                if (status === 'delivered' && order.updatedAt) {
                    // ƒê∆°n h√†ng ƒë√£ ho√†n th√†nh: d√πng ng√†y c·∫≠p nh·∫≠t (ng√†y ho√†n th√†nh)
                    orderDate = new Date(order.updatedAt).toLocaleDateString('vi-VN');
                } else {
                    // Fallback: d√πng ng√†y t·∫°o ƒë∆°n h√†ng
                    orderDate = new Date(order.createdAt || order.date || Date.now()).toLocaleDateString('vi-VN');
                }
                
                // S·ª≠ d·ª•ng finalAmount (sau khi tr·ª´ discount) thay v√¨ totalAmount
                const orderTotal = order.finalAmount || order.totalAmount || order.total || order.amount || order.price || 0;
                totalRevenue += orderTotal;
                
                if (!revenueByDate[orderDate]) {
                    revenueByDate[orderDate] = { count: 0, revenue: 0 };
                    ordersByDate[orderDate] = [];
                }
                revenueByDate[orderDate].count++;
                revenueByDate[orderDate].revenue += orderTotal;
                ordersByDate[orderDate].push(order); // Store order for detail view
            });
            
            // Update summary cards
            document.getElementById('totalRevenue').textContent = 
                new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalRevenue);
            document.getElementById('totalOrders').textContent = totalOrders;
            
            // Display revenue table
            displayRevenueTable(revenueByDate);
        }
        
        // Display mock revenue data (for demonstration)
        function displayMockRevenue() {
            const now = new Date();
            const dayPicker = document.getElementById('dayPicker');
            const dayPickerEnd = document.getElementById('dayPickerEnd');
            
            // Generate mock data based on selected date range
            let mockOrders = [];
            let datesToGenerate = [];
            
            if (dayPicker.value) {
                const startDate = new Date(dayPicker.value);
                let endDate;
                
                if (dayPickerEnd.value) {
                    endDate = new Date(dayPickerEnd.value);
                } else {
                    // If no end date, use start date as end date (single day)
                    endDate = new Date(startDate);
                }
                
                // Generate dates from start to end
                const currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    datesToGenerate.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            } else {
                // Generate data for last 6 months if no filter (for "T·∫•t c·∫£")
                for (let monthOffset = 5; monthOffset >= 0; monthOffset--) {
                    const targetDate = new Date(now.getFullYear(), now.getMonth() - monthOffset, 1);
                    const daysInMonth = new Date(targetDate.getFullYear(), targetDate.getMonth() + 1, 0).getDate();
                    for (let i = 1; i <= daysInMonth; i++) {
                        datesToGenerate.push(new Date(targetDate.getFullYear(), targetDate.getMonth(), i));
                    }
                }
            }
            
            datesToGenerate.forEach(date => {
                const orderCount = Math.floor(Math.random() * 10) + 1;
                const dailyRevenue = orderCount * (Math.random() * 500000 + 100000);
                
                mockOrders.push({
                    date: date.toLocaleDateString('vi-VN'),
                    count: orderCount,
                    revenue: dailyRevenue
                });
            });
            
            let totalRevenue = mockOrders.reduce((sum, o) => sum + o.revenue, 0);
            let totalOrders = mockOrders.reduce((sum, o) => sum + o.count, 0);
            
            document.getElementById('totalRevenue').textContent = 
                new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalRevenue);
            document.getElementById('totalOrders').textContent = totalOrders;
            
            const revenueByDate = {};
            ordersByDate = {}; // Reset orders by date for mock data
            
            mockOrders.forEach(order => {
                revenueByDate[order.date] = { count: order.count, revenue: order.revenue };
                
                // Create mock order objects for detail view
                if (!ordersByDate[order.date]) {
                    ordersByDate[order.date] = [];
                }
                
                // Generate mock orders for this date
                // Parse date from vi-VN format (dd/mm/yyyy) to Date object
                const dateParts = order.date.split('/');
                const parsedDate = new Date(parseInt(dateParts[2]), parseInt(dateParts[1]) - 1, parseInt(dateParts[0]));
                
                for (let i = 0; i < order.count; i++) {
                    const orderAmount = order.revenue / order.count;
                    const quantity = Math.floor(Math.random() * 3) + 1;
                    const mockOrder = {
                        _id: `mock_${order.date.replace(/\//g, '_')}_${i}`,
                        orderCode: `ORD${String(Math.floor(Math.random() * 1000000)).padStart(6, '0')}`,
                        customer: {
                            name: `Kh√°ch h√†ng ${i + 1}`,
                            phone: `0${Math.floor(Math.random() * 900000000) + 100000000}`
                        },
                        finalAmount: orderAmount,
                        totalAmount: orderAmount,
                        items: [
                            {
                                product: { name: `S·∫£n ph·∫©m ${i + 1}` },
                                quantity: quantity,
                                price: orderAmount / quantity
                            }
                        ],
                        createdAt: parsedDate.toISOString(),
                        updatedAt: parsedDate.toISOString(),
                        paymentStatus: Math.random() > 0.5 ? 'paid' : 'pending',
                        status: 'delivered'
                    };
                    ordersByDate[order.date].push(mockOrder);
                }
            });
            
            displayRevenueTable(revenueByDate);
        }
        
        // Display revenue table
        function displayRevenueTable(revenueByDate) {
            const tbody = document.getElementById('revenueTableBody');
            const dates = Object.keys(revenueByDate).sort((a, b) => {
                return new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-'));
            });
            
            if (dates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }
            
            tbody.innerHTML = dates.map(date => {
                const data = revenueByDate[date];
                return `
                    <tr>
                        <td><strong>${date}</strong></td>
                        <td>${data.count}</td>
                        <td style="color: #10b981; font-weight: 600;">
                            ${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.revenue)}
                        </td>
                        <td>
                            <button onclick="viewRevenueDetails('${date}')" class="btn btn-sm btn-secondary">üëÅÔ∏è Xem chi ti·∫øt</button>
                        </td>
                        <td>
                            <button onclick="showDeleteRevenueByDateModal('${date}')" class="btn btn-sm" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">üóëÔ∏è X√≥a</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // View revenue details for a specific date
        function viewRevenueDetails(date) {
            const orders = ordersByDate[date] || [];
            const content = document.getElementById('revenueDetailsContent');
            
            if (orders.length === 0) {
                content.innerHTML = '<div class="empty" style="text-align: center; padding: 40px;">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o trong ng√†y n√†y</div>';
                showModal('revenueDetailsModal');
                return;
            }
            
            // Calculate total revenue for the day
            const dayRevenue = orders.reduce((sum, order) => {
                return sum + (order.finalAmount || order.totalAmount || order.total || order.amount || order.price || 0);
            }, 0);
            
            // Generate orders list HTML
            const ordersHtml = orders.map((order, index) => {
                const orderId = order._id || order.id || 'N/A';
                const orderCode = order.orderCode || order.code || orderId.substring(0, 8).toUpperCase();
                const customerName = (order.customer && order.customer.name) || order.customerName || 'N/A';
                const customerPhone = (order.customer && order.customer.phone) || order.customerPhone || '';
                const orderTotal = order.finalAmount || order.totalAmount || order.total || order.amount || order.price || 0;
                const createdAt = order.createdAt || order.updatedAt || order.date || new Date();
                const paymentStatus = order.paymentStatus || order.payment_status || 'pending';
                
                // Get items info
                const items = order.items || order.products || [];
                const itemsCount = items.length;
                const itemsInfo = items.length > 0 
                    ? items.map(item => `${item.product?.name || item.name || 'S·∫£n ph·∫©m'} (x${item.quantity || 1})`).join(', ')
                    : 'N/A';
                
                // Trang doanh thu ch·ªâ hi·ªÉn th·ªã ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh, n√™n t·∫•t c·∫£ ƒë·ªÅu ƒë√£ thanh to√°n
                const paymentStatusText = 'ƒê√£ thanh to√°n';
                
                return `
                    <div style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow-sm);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <h3 style="color: var(--primary-color); margin: 0 0 5px 0; font-size: 16px;">M√£ ƒë∆°n: #${orderCode}</h3>
                                <p style="margin: 0; color: var(--gray-600); font-size: 14px;">${formatDate(createdAt)}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: 700; color: var(--success-color);">
                                    ${formatCurrency(orderTotal)}
                                </div>
                                <div style="font-size: 12px; color: var(--gray-600); margin-top: 5px;">
                                    ${paymentStatusText}
                                </div>
                            </div>
                        </div>
                        <div style="border-top: 1px solid var(--gray-200); padding-top: 10px; margin-top: 10px;">
                            <p style="margin: 5px 0; color: var(--gray-700);"><strong>Kh√°ch h√†ng:</strong> ${customerName}${customerPhone ? ` - ${customerPhone}` : ''}</p>
                            <p style="margin: 5px 0; color: var(--gray-700);"><strong>S·∫£n ph·∫©m:</strong> ${itemsCount} s·∫£n ph·∫©m</p>
                            ${itemsInfo !== 'N/A' && itemsInfo.length < 100 ? `<p style="margin: 5px 0; color: var(--gray-600); font-size: 13px;">${itemsInfo}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; font-size: 18px; opacity: 0.9;">Doanh thu ng√†y ${date}</h3>
                        <div style="font-size: 28px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                            ${formatCurrency(dayRevenue)}
                        </div>
                        <div style="font-size: 14px; opacity: 0.9; margin-top: 10px;">
                            T·ªïng c·ªông: ${orders.length} ƒë∆°n h√†ng
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 15px; color: var(--gray-700);">Danh s√°ch ƒë∆°n h√†ng (${orders.length})</h3>
                    <div style="max-height: 500px; overflow-y: auto;">
                        ${ordersHtml}
                    </div>
                </div>
            `;
            
            showModal('revenueDetailsModal');
        }
        
        // Close revenue details modal
        function closeRevenueDetails() {
            hideModal('revenueDetailsModal');
        }
        
        // Variables for delete operations
        let currentDeleteDate = null;
        let currentDeletePeriod = null;
        
        // Show delete revenue modal for current filter
        function showDeleteRevenueModal() {
            const dayPicker = document.getElementById('dayPicker');
            const dayPickerEnd = document.getElementById('dayPickerEnd');
            const info = document.getElementById('deleteRevenueInfo');
            
            let periodText = '';
            let periodType = '';
            
            if (dayPicker.value) {
                const startDate = new Date(dayPicker.value);
                let endDate;
                
                if (dayPickerEnd.value) {
                    endDate = new Date(dayPickerEnd.value);
                    periodText = `T·ª´ ${startDate.toLocaleDateString('vi-VN')} ƒë·∫øn ${endDate.toLocaleDateString('vi-VN')}`;
                    periodType = 'range';
                } else {
                    periodText = `Ng√†y ${startDate.toLocaleDateString('vi-VN')}`;
                    periodType = 'day';
                }
                currentDeletePeriod = { type: periodType, value: dayPicker.value, valueEnd: dayPickerEnd.value };
            } else {
                periodText = 'T·∫•t c·∫£ doanh thu';
                periodType = 'all';
                currentDeletePeriod = { type: periodType, value: null };
            }
            
            // Calculate total orders and revenue for this period
            const totalOrders = document.getElementById('totalOrders').textContent;
            const totalRevenue = document.getElementById('totalRevenue').textContent;
            
            info.innerHTML = `
                <p style="margin: 0 0 10px 0; font-weight: 600; color: var(--gray-700);">K·ª≥: ${periodText}</p>
                <p style="margin: 5px 0; color: var(--gray-600);">T·ªïng ƒë∆°n h√†ng: <strong>${totalOrders}</strong></p>
                <p style="margin: 5px 0; color: var(--gray-600);">T·ªïng doanh thu: <strong style="color: #10b981;">${totalRevenue}</strong></p>
            `;
            
            showModal('deleteRevenueModal');
        }
        
        // Close delete revenue modal
        function closeDeleteRevenueModal() {
            hideModal('deleteRevenueModal');
            currentDeletePeriod = null;
        }
        
        // Confirm delete revenue for current filter
        async function confirmDeleteRevenue() {
            if (!currentDeletePeriod) return;
            
            try {
                const token = localStorage.getItem('adminToken');
                const orders = [];
                
                // Get all orders for the period
                if (currentDeletePeriod.type === 'day' || currentDeletePeriod.type === 'range') {
                    const dayPicker = document.getElementById('dayPicker');
                    const dayPickerEnd = document.getElementById('dayPickerEnd');
                    let url = `/api/orders?day=${dayPicker.value}`;
                    if (dayPickerEnd.value) {
                        url += `&dayEnd=${dayPickerEnd.value}`;
                    }
                    const response = await apiCall(url);
                    if (response.ok) {
                        const data = await response.json();
                        const allOrders = Array.isArray(data) ? data : (data.orders || data.data || []);
                        orders.push(...allOrders.filter(o => (o.status || o.orderStatus) === 'delivered'));
                    }
                } else {
                    // All orders
                    const response = await apiCall('/api/orders');
                    if (response.ok) {
                        const data = await response.json();
                        const allOrders = Array.isArray(data) ? data : (data.orders || data.data || []);
                        orders.push(...allOrders.filter(o => (o.status || o.orderStatus) === 'delivered'));
                    }
                }
                
                // Delete/cancel all delivered orders
                let successCount = 0;
                let errorCount = 0;
                
                for (const order of orders) {
                    const orderId = order._id || order.id;
                    if (!orderId) continue;
                    
                    try {
                        // Try to cancel the order (change status to cancelled)
                        const response = await apiCall(`/api/orders/${orderId}/status`, {
                            method: 'PUT',
                            body: JSON.stringify({ status: 'cancelled' })
                        });
                        
                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        errorCount++;
                    }
                }
                
                closeDeleteRevenueModal();
                
                if (successCount > 0) {
                    showSuccess(`‚úÖ ƒê√£ x√≥a ${successCount} ƒë∆°n h√†ng th√†nh c√¥ng!${errorCount > 0 ? ` (${errorCount} l·ªói)` : ''}`, document.querySelector('.container'));
                    setTimeout(() => {
                        loadRevenue();
                    }, 500);
                } else {
                    alert(`Kh√¥ng th·ªÉ x√≥a ƒë∆°n h√†ng. ${errorCount > 0 ? `C√≥ ${errorCount} l·ªói x·∫£y ra.` : 'Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o.'}`);
                }
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }
        
        // Show delete revenue by date modal
        function showDeleteRevenueByDateModal(date) {
            currentDeleteDate = date;
            const info = document.getElementById('deleteRevenueByDateInfo');
            const orders = ordersByDate[date] || [];
            const totalRevenue = orders.reduce((sum, order) => {
                return sum + (order.finalAmount || order.totalAmount || order.total || order.amount || order.price || 0);
            }, 0);
            
            info.innerHTML = `
                <p style="margin: 0 0 10px 0; font-weight: 600; color: var(--gray-700);">Ng√†y: ${date}</p>
                <p style="margin: 5px 0; color: var(--gray-600);">S·ªë ƒë∆°n h√†ng: <strong>${orders.length}</strong></p>
                <p style="margin: 5px 0; color: var(--gray-600);">T·ªïng doanh thu: <strong style="color: #10b981;">${formatCurrency(totalRevenue)}</strong></p>
            `;
            
            showModal('deleteRevenueByDateModal');
        }
        
        // Close delete revenue by date modal
        function closeDeleteRevenueByDateModal() {
            hideModal('deleteRevenueByDateModal');
            currentDeleteDate = null;
        }
        
        // Confirm delete revenue by date
        async function confirmDeleteRevenueByDate() {
            if (!currentDeleteDate) return;
            
            try {
                const orders = ordersByDate[currentDeleteDate] || [];
                
                if (orders.length === 0) {
                    alert('Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒë·ªÉ x√≥a.');
                    closeDeleteRevenueByDateModal();
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const order of orders) {
                    const orderId = order._id || order.id;
                    if (!orderId) continue;
                    
                    try {
                        // Try to cancel the order (change status to cancelled)
                        const response = await apiCall(`/api/orders/${orderId}/status`, {
                            method: 'PUT',
                            body: JSON.stringify({ status: 'cancelled' })
                        });
                        
                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        errorCount++;
                    }
                }
                
                closeDeleteRevenueByDateModal();
                
                if (successCount > 0) {
                    showSuccess(`‚úÖ ƒê√£ x√≥a ${successCount} ƒë∆°n h√†ng th√†nh c√¥ng!${errorCount > 0 ? ` (${errorCount} l·ªói)` : ''}`, document.querySelector('.container'));
                    setTimeout(() => {
                        loadRevenue();
                    }, 500);
                } else {
                    alert(`Kh√¥ng th·ªÉ x√≥a ƒë∆°n h√†ng. ${errorCount > 0 ? `C√≥ ${errorCount} l·ªói x·∫£y ra.` : ''}`);
                }
            } catch (error) {
                alert('L·ªói: ' + error.message);
            }
        }
        
        // Load revenue on page load
        loadRevenue();
    </script>
</body>
</html>