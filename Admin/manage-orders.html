<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1>Qu·∫£n l√Ω ƒë∆°n h√†ng</h1>
            <div class="nav-actions">
                <button onclick="window.location.href='dashboard.html'" class="btn btn-secondary">üè† V·ªÅ Dashboard</button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="filter-bar">
            <div class="filter-group">
                <label>üîç T√¨m ki·∫øm:</label>
                <input type="text" id="searchInput" placeholder="T√¨m theo m√£ ƒë∆°n, t√™n kh√°ch h√†ng..." style="padding: 10px 16px; border: 2px solid var(--gray-200); border-radius: 12px; font-size: 15px; min-width: 250px;" onkeyup="loadOrders()">
            </div>
            <div class="filter-group">
                <label>Tr·∫°ng th√°i thanh to√°n:</label>
                <select id="paymentStatusFilter" onchange="loadOrders()">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="pending">Ch·ªù thanh to√°n</option>
                    <option value="paid">ƒê√£ thanh to√°n</option>
                    <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                    <option value="cancelled">ƒê√£ h·ªßy</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Tr·∫°ng th√°i ƒë∆°n h√†ng:</label>
                <select id="orderStatusFilter" onchange="loadOrders()">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
                    <option value="confirmed">ƒê√£ x√°c nh·∫≠n</option>
                    <option value="shipping">ƒêang giao h√†ng</option>
                    <option value="delivered">ƒê√£ nh·∫≠n h√†ng</option>
                    <option value="cancelled">ƒê√£ h·ªßy</option>
                </select>
            </div>
        </div>
        
        <div class="table-container">
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>M√£ ƒë∆°n</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>S·∫£n ph·∫©m</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>Thanh to√°n</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Ng√†y t·∫°o</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <tr><td colspan="8" class="loading">ƒêang t·∫£i...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Order Detail Modal -->
    <div id="orderDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeOrderDetail()">&times;</span>
            <h2>Chi ti·∫øt ƒë∆°n h√†ng</h2>
            <div id="orderDetailContent">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
    
    <!-- Confirm Order Modal -->
    <div id="confirmOrderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeConfirmModal()">&times;</span>
            <h2>X√°c nh·∫≠n ƒë∆°n h√†ng</h2>
            <p>B·∫°n c√≥ ch·∫Øc mu·ªën x√°c nh·∫≠n ƒë∆°n h√†ng n√†y?</p>
            <div id="confirmOrderInfo" style="background: var(--gray-100); padding: 15px; border-radius: 8px; margin: 15px 0;"></div>
            <div class="form-actions">
                <button type="button" onclick="closeConfirmModal()" class="btn btn-secondary">H·ªßy</button>
                <button type="button" onclick="confirmOrderAction()" class="btn btn-primary">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
    
    <!-- Complete Order Modal -->
    <div id="completeOrderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCompleteModal()">&times;</span>
            <h2>Ho√†n th√†nh ƒë∆°n h√†ng</h2>
            <p>ƒê√°nh d·∫•u ƒë∆°n h√†ng n√†y l√† ƒë√£ ho√†n th√†nh? ƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c t√≠nh v√†o doanh thu.</p>
            <div id="completeOrderInfo" style="background: var(--gray-100); padding: 15px; border-radius: 8px; margin: 15px 0;"></div>
            <div class="form-actions">
                <button type="button" onclick="closeCompleteModal()" class="btn btn-secondary">H·ªßy</button>
                <button type="button" onclick="completeOrderAction()" class="btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">üéâ Ho√†n th√†nh</button>
            </div>
        </div>
    </div>
    
    <!-- Cancel Order Modal -->
    <div id="cancelOrderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCancelModal()">&times;</span>
            <h2>‚ùå H·ªßy ƒë∆°n h√†ng</h2>
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?</p>
            <div id="cancelOrderInfo" style="background: var(--gray-100); padding: 15px; border-radius: 8px; margin: 15px 0;"></div>
            <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <p style="margin: 0; color: #991b1b; font-weight: 600;">‚ö†Ô∏è C·∫£nh b√°o:</p>
                <p style="margin: 5px 0 0 0; color: #7f1d1d;">H·ªßy ƒë∆°n h√†ng s·∫Ω:</p>
                <ul style="margin: 5px 0 0 20px; color: #7f1d1d;">
                    <li>Tr·∫£ l·∫°i s·ªë l∆∞·ª£ng s·∫£n ph·∫©m v√†o kho</li>
                    <li>Kh√¥ng th·ªÉ ho√†n t√°c h√†nh ƒë·ªông n√†y</li>
                    <li>Th√¥ng b√°o cho kh√°ch h√†ng v·ªÅ vi·ªác h·ªßy ƒë∆°n</li>
                </ul>
            </div>
            <div class="form-actions">
                <button type="button" onclick="closeCancelModal()" class="btn btn-secondary">Kh√¥ng h·ªßy</button>
                <button type="button" onclick="cancelOrderAction()" class="btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">‚ùå X√°c nh·∫≠n h·ªßy</button>
            </div>
        </div>
    </div>
    
    <script src="admin.js"></script>
    <script>
        checkAuth();
        loadOrders();
        
        let currentOrderId = null;
        
        async function loadOrders() {
            const search = document.getElementById('searchInput').value;
            const paymentStatus = document.getElementById('paymentStatusFilter').value;
            const orderStatus = document.getElementById('orderStatusFilter').value;
            const token = localStorage.getItem('adminToken');
            
            const params = new URLSearchParams();
            if (search) params.append('search', search);
            if (paymentStatus) params.append('paymentStatus', paymentStatus);
            if (orderStatus) params.append('status', orderStatus);
            
            try {
                const response = await apiCall(`/api/orders?${params}`);
                
                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng');
                }
                
                const orders = await response.json();
                displayOrders(Array.isArray(orders) ? orders : (orders.orders || orders.data || []));
            } catch (error) {
                document.getElementById('ordersTableBody').innerHTML = 
                    '<tr><td colspan="8" class="error">L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message + '</td></tr>';
            }
        }
        
        function displayOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => {
                const orderId = order._id || order.id || 'N/A';
                const orderCode = order.orderCode || order.code || orderId.substring(0, 8).toUpperCase();
                const customerName = (order.customer && order.customer.name) || order.customerName || 'N/A';
                const customerEmail = (order.customer && order.customer.email) || order.customerEmail || '';
                // S·ª≠ d·ª•ng finalAmount (sau khi tr·ª´ discount) l√†m t·ªïng ti·ªÅn ch√≠nh
                const total = order.finalAmount || order.totalAmount || order.total || order.amount || order.price || 0;
                const totalAmount = order.totalAmount || order.total || order.amount || order.price || 0;
                const discountAmount = order.discountAmount || 0;
                const paymentStatus = order.paymentStatus || order.payment_status || 'pending';
                const orderStatus = order.status || order.orderStatus || 'pending';
                const createdAt = order.createdAt || order.created_at || order.date || new Date();
                
                // Get items info
                let itemsInfo = 'N/A';
                if (order.items && order.items.length > 0) {
                    itemsInfo = `${order.items.length} s·∫£n ph·∫©m`;
                } else if (order.products && order.products.length > 0) {
                    itemsInfo = `${order.products.length} s·∫£n ph·∫©m`;
                }
                
                // Payment status badge
                let paymentBadge = '';
                if (paymentStatus === 'paid' || paymentStatus === 'confirmed') {
                    paymentBadge = '<span class="badge badge-success">ƒê√£ thanh to√°n</span>';
                } else if (paymentStatus === 'pending') {
                    paymentBadge = '<span class="badge badge-warning">Ch·ªù thanh to√°n</span>';
                } else if (paymentStatus === 'cancelled') {
                    paymentBadge = '<span class="badge badge-danger">ƒê√£ h·ªßy</span>';
                } else {
                    paymentBadge = '<span class="badge badge-secondary">' + paymentStatus + '</span>';
                }
                
                // Order status badge
                let statusBadge = '';
                if (orderStatus === 'delivered') {
                    statusBadge = '<span class="badge badge-success">ƒê√£ nh·∫≠n h√†ng</span>';
                } else if (orderStatus === 'shipping') {
                    statusBadge = '<span class="badge badge-info">ƒêang giao h√†ng</span>';
                } else if (orderStatus === 'confirmed') {
                    statusBadge = '<span class="badge badge-info">ƒê√£ x√°c nh·∫≠n</span>';
                } else if (orderStatus === 'pending') {
                    statusBadge = '<span class="badge badge-warning">Ch·ªù x·ª≠ l√Ω</span>';
                } else if (orderStatus === 'cancelled') {
                    statusBadge = '<span class="badge badge-danger">ƒê√£ h·ªßy</span>';
                } else {
                    statusBadge = '<span class="badge badge-secondary">' + orderStatus + '</span>';
                }
                
                // Cho ph√©p x√°c nh·∫≠n ngay c·∫£ khi ch∆∞a thanh to√°n, ch·ªâ c·∫ßn ƒë∆°n ƒëang ch·ªù x·ª≠ l√Ω
                const canConfirm = orderStatus === 'pending';
                // Cho ph√©p ho√†n th√†nh khi ƒë∆°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n (confirmed/shipping), kh√¥ng c·∫ßn ki·ªÉm tra thanh to√°n
                const canComplete = orderStatus === 'confirmed' || orderStatus === 'shipping';
                // Cho ph√©p h·ªßy ƒë∆°n h√†ng khi ch∆∞a ƒë∆∞·ª£c giao (pending, confirmed, shipping)
                const canCancel = orderStatus === 'pending' || orderStatus === 'confirmed' || orderStatus === 'shipping';
                
                return `
                    <tr>
                        <td><strong>#${orderCode}</strong></td>
                        <td>
                            <div>${customerName}</div>
                            ${customerEmail ? `<div style="font-size: 12px; color: var(--gray-600);">${customerEmail}</div>` : ''}
                        </td>
                        <td>${itemsInfo}</td>
                        <td>
                            <strong>${formatCurrency(total)}</strong>
                            ${discountAmount > 0 ? `<br><small style="color: #64748b; text-decoration: line-through;">${formatCurrency(totalAmount)}</small><br><small style="color: #10b981;">Gi·∫£m: ${formatCurrency(discountAmount)}</small>` : ''}
                        </td>
                        <td>${paymentBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${formatDate(createdAt)}</td>
                        <td>
                            <button onclick="viewOrderDetail('${orderId}')" class="btn btn-sm btn-primary" style="margin-right: 5px;">üëÅÔ∏è Xem</button>
                            ${canConfirm ? `<button onclick="showConfirmModal('${orderId}')" class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-right: 5px;">‚úÖ X√°c nh·∫≠n</button>` : ''}
                            ${canComplete ? `<button onclick="showCompleteModal('${orderId}')" class="btn btn-sm" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-right: 5px;">üéâ Ho√†n th√†nh</button>` : ''}
                            ${canCancel ? `<button onclick="showCancelModal('${orderId}')" class="btn btn-sm" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; margin-right: 5px;">‚ùå H·ªßy ƒë∆°n</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { 
                style: 'currency', 
                currency: 'VND' 
            }).format(amount);
        }
        
        async function viewOrderDetail(orderId) {
            const token = localStorage.getItem('adminToken');
            const content = document.getElementById('orderDetailContent');
            content.innerHTML = '<div class="spinner"></div>';
            showModal('orderDetailModal');
            
            try {
                const response = await apiCall(`/api/orders/${orderId}`);
                
                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `L·ªói ${response.status}`);
                    } else {
                        throw new Error(`L·ªói ${response.status}: Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng. Vui l√≤ng ki·ªÉm tra l·∫°i API.`);
                    }
                }
                
                // Ki·ªÉm tra Content-Type tr∆∞·ªõc khi parse JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('API tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i API endpoint.');
                }
                
                const order = await response.json();
                displayOrderDetail(order);
            } catch (error) {
                console.error('Error loading order detail:', error);
                content.innerHTML = `<div class="error">L·ªói: ${error.message}</div>`;
            }
        }
        
        function displayOrderDetail(order) {
            const content = document.getElementById('orderDetailContent');
            const orderId = order._id || order.id || 'N/A';
            const orderCode = order.orderCode || order.code || orderId.substring(0, 8).toUpperCase();
            const customerName = (order.customer && order.customer.name) || order.customerName || 'N/A';
            const customerEmail = (order.customer && order.customer.email) || order.customerEmail || '';
            const customerPhone = (order.customer && order.customer.phone) || order.customerPhone || '';
            const customerAddress = (order.customer && order.customer.address) || order.shippingAddress || order.address || '';
            const paymentStatus = order.paymentStatus || order.payment_status || 'pending';
            const orderStatus = order.status || order.orderStatus || 'pending';
            const createdAt = order.createdAt || order.created_at || order.date || new Date();
            
            const items = order.items || order.products || [];
            
            // T√≠nh t·ªïng ti·ªÅn t·ª´ c√°c items
            let calculatedTotal = 0;
            let itemsHtml = '';
            if (items.length > 0) {
                itemsHtml = items.map(item => {
                    const productName = (item.product && item.product.name) || item.name || 'S·∫£n ph·∫©m';
                    const quantity = item.quantity || 1;
                    const price = item.price || 0;
                    const subtotal = price * quantity;
                    calculatedTotal += subtotal;
                    return `
                        <tr>
                            <td>${productName}</td>
                            <td style="text-align: center;">${quantity}</td>
                            <td style="text-align: right;">${formatCurrency(price)}</td>
                            <td style="text-align: right;"><strong>${formatCurrency(subtotal)}</strong></td>
                        </tr>
                    `;
                }).join('');
            } else {
                itemsHtml = '<tr><td colspan="4" style="text-align: center; color: var(--gray-600);">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>';
            }
            
            // S·ª≠ d·ª•ng finalAmount (sau khi tr·ª´ discount) l√†m t·ªïng ti·ªÅn ch√≠nh
            const finalAmount = order.finalAmount || order.totalAmount || order.total || order.amount || order.price || calculatedTotal;
            const totalAmount = order.totalAmount || order.total || order.amount || order.price || calculatedTotal;
            const discountAmount = order.discountAmount || 0;
            const total = finalAmount; // T·ªïng ti·ªÅn cu·ªëi c√πng c·∫ßn thanh to√°n
            
            const paymentStatusText = paymentStatus === 'paid' || paymentStatus === 'confirmed' ? 'ƒê√£ thanh to√°n' : 
                                     paymentStatus === 'pending' ? 'Ch·ªù thanh to√°n' : paymentStatus;
            
            const orderStatusText = orderStatus === 'delivered' ? 'ƒê√£ nh·∫≠n h√†ng' :
                                   orderStatus === 'shipping' ? 'ƒêang giao h√†ng' :
                                   orderStatus === 'confirmed' ? 'ƒê√£ x√°c nh·∫≠n' :
                                   orderStatus === 'pending' ? 'Ch·ªù x·ª≠ l√Ω' :
                                   orderStatus === 'cancelled' ? 'ƒê√£ h·ªßy' : orderStatus;
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">M√£ ƒë∆°n: #${orderCode}</h3>
                    
                    <div style="background: var(--gray-100); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px;">Th√¥ng tin kh√°ch h√†ng</h4>
                        <p><strong>T√™n:</strong> ${customerName}</p>
                        ${customerEmail ? `<p><strong>Email:</strong> ${customerEmail}</p>` : ''}
                        ${customerPhone ? `<p><strong>ƒêi·ªán tho·∫°i:</strong> ${customerPhone}</p>` : ''}
                        ${customerAddress ? `<p><strong>ƒê·ªãa ch·ªâ:</strong> ${customerAddress}</p>` : ''}
                    </div>
                    
                    <div style="background: var(--gray-100); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px;">Tr·∫°ng th√°i</h4>
                        <p><strong>Thanh to√°n:</strong> ${paymentStatusText}</p>
                        <p><strong>ƒê∆°n h√†ng:</strong> ${orderStatusText}</p>
                        <p><strong>Ng√†y t·∫°o:</strong> ${formatDate(createdAt)}</p>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; text-align: center;">
                        <h4 style="margin: 0 0 10px 0; font-size: 16px; opacity: 0.9;">T·ªïng ti·ªÅn ${orderStatus === 'pending' ? 'c·∫ßn x√°c nh·∫≠n' : orderStatus === 'confirmed' || orderStatus === 'shipping' ? 'ƒë∆°n h√†ng' : 'ƒë∆°n h√†ng'}</h4>
                        ${discountAmount > 0 ? `
                            <div style="font-size: 18px; opacity: 0.9; text-decoration: line-through; margin-bottom: 5px;">${formatCurrency(totalAmount)}</div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">Gi·∫£m: ${formatCurrency(discountAmount)}</div>
                        ` : ''}
                        <div style="font-size: 32px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">${formatCurrency(total)}</div>
                    </div>
                    
                    <h4 style="margin-bottom: 10px;">Chi ti·∫øt s·∫£n ph·∫©m</h4>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                        <thead>
                            <tr style="background: var(--gray-200);">
                                <th style="padding: 10px; text-align: left;">S·∫£n ph·∫©m</th>
                                <th style="padding: 10px; text-align: center;">S·ªë l∆∞·ª£ng</th>
                                <th style="padding: 10px; text-align: right;">ƒê∆°n gi√°</th>
                                <th style="padding: 10px; text-align: right;">Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                        <tfoot>
                            ${discountAmount > 0 ? `
                            <tr>
                                <td colspan="3" style="padding: 10px; text-align: right;"><strong>T·∫°m t√≠nh:</strong></td>
                                <td style="padding: 10px; text-align: right;"><strong>${formatCurrency(totalAmount)}</strong></td>
                            </tr>
                            <tr>
                                <td colspan="3" style="padding: 10px; text-align: right;"><strong style="color: #10b981;">Gi·∫£m gi√°:</strong></td>
                                <td style="padding: 10px; text-align: right;"><strong style="color: #10b981;">-${formatCurrency(discountAmount)}</strong></td>
                            </tr>
                            ` : ''}
                            <tr style="border-top: 2px solid var(--gray-300);">
                                <td colspan="3" style="padding: 10px; text-align: right;"><strong>T·ªïng c·ªông:</strong></td>
                                <td style="padding: 10px; text-align: right;"><strong style="color: var(--primary-color); font-size: 18px;">${formatCurrency(total)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        ${orderStatus === 'pending' ? 
                            `<button onclick="closeOrderDetail(); showConfirmModal('${orderId}');" class="btn btn-primary" style="flex: 1; min-width: 150px;">‚úÖ X√°c nh·∫≠n ƒë∆°n h√†ng</button>` : 
                            ''}
                        ${orderStatus === 'confirmed' || orderStatus === 'shipping' ? 
                            `<button onclick="closeOrderDetail(); showCompleteModal('${orderId}');" class="btn" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">üéâ Ho√†n th√†nh ƒë∆°n h√†ng</button>` : 
                            ''}
                        ${orderStatus === 'pending' || orderStatus === 'confirmed' || orderStatus === 'shipping' ? 
                            `<button onclick="closeOrderDetail(); showCancelModal('${orderId}');" class="btn" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">‚ùå H·ªßy ƒë∆°n h√†ng</button>` : 
                            ''}
                    </div>
                </div>
            `;
        }
        
        function closeOrderDetail() {
            hideModal('orderDetailModal');
        }
        
        function showConfirmModal(orderId) {
            currentOrderId = orderId;
            const info = document.getElementById('confirmOrderInfo');
            info.innerHTML = 'ƒêang t·∫£i th√¥ng tin...';
            showModal('confirmOrderModal');
            
            // Load order info
            const token = localStorage.getItem('adminToken');
            fetch(`${API_BASE_URL}/api/orders/${orderId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(async res => {
                // Ki·ªÉm tra Content-Type tr∆∞·ªõc khi parse JSON
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    throw new Error('API tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i API endpoint.');
                }
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ error: `L·ªói ${res.status}: ${res.statusText}` }));
                    throw new Error(errorData.error || `L·ªói ${res.status}`);
                }
                
                return res.json();
            })
            .then(order => {
                const orderCode = order.orderCode || order.code || orderId.substring(0, 8).toUpperCase();
                const items = order.items || order.products || [];
                
                // T√≠nh t·ªïng ti·ªÅn t·ª´ items n·∫øu order.total kh√¥ng c√≥
                let calculatedTotal = 0;
                if (items.length > 0) {
                    items.forEach(item => {
                        const quantity = item.quantity || 1;
                        const price = item.price || 0;
                        calculatedTotal += price * quantity;
                    });
                }
                
                // S·ª≠ d·ª•ng finalAmount (sau khi tr·ª´ discount) l√†m t·ªïng ti·ªÅn ch√≠nh
                const finalAmount = order.finalAmount || order.totalAmount || order.total || order.amount || order.price || calculatedTotal;
                const totalAmount = order.totalAmount || order.total || order.amount || order.price || calculatedTotal;
                const discountAmount = order.discountAmount || 0;
                const total = finalAmount;
                const customerName = (order.customer && order.customer.name) || order.customerName || 'N/A';
                
                info.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <p><strong>M√£ ƒë∆°n:</strong> #${orderCode}</p>
                        <p><strong>Kh√°ch h√†ng:</strong> ${customerName}</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-top: 15px;">
                        <p style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.9;">S·ªë ti·ªÅn c·∫ßn x√°c nh·∫≠n</p>
                        ${discountAmount > 0 ? `
                            <div style="font-size: 14px; opacity: 0.8; text-decoration: line-through; margin-bottom: 5px;">${formatCurrency(totalAmount)}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 8px;">Gi·∫£m: ${formatCurrency(discountAmount)}</div>
                        ` : ''}
                        <div style="font-size: 28px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">${formatCurrency(total)}</div>
                    </div>
                `;
            })
            .catch(err => {
                console.error('Error loading order:', err);
                info.innerHTML = `<p style="color: var(--danger-color);">L·ªói: ${err.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng'}</p>`;
            });
        }
        
        function closeConfirmModal() {
            hideModal('confirmOrderModal');
            currentOrderId = null;
        }
        
        async function confirmOrderAction() {
            if (!currentOrderId) return;
            
            const token = localStorage.getItem('adminToken');
            try {
                // S·ª≠ d·ª•ng endpoint /api/orders/:id/confirm ƒë·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng
                const response = await apiCall(`/api/orders/${currentOrderId}/confirm`, {
                    method: 'PUT'
                });
                
                // Ki·ªÉm tra k·∫øt qu·∫£
                if (!response.ok) {
                    const contentType = response?.headers?.get('content-type');
                    let errorMessage = 'Kh√¥ng th·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng. ';
                    
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            const data = await response.json();
                            errorMessage += data.error || `L·ªói ${response.status}`;
                        } catch (e) {
                            errorMessage += `L·ªói ${response.status}`;
                        }
                    } else {
                        errorMessage += `L·ªói ${response.status}`;
                    }
                    throw new Error(errorMessage);
                }
                
                // ƒê·ªçc response JSON
                const result = await response.json();
                
                closeConfirmModal();
                closeOrderDetail(); // ƒê√≥ng modal chi ti·∫øt n·∫øu ƒëang m·ªü
                showSuccess('‚úÖ ƒê√£ x√°c nh·∫≠n ƒë∆°n h√†ng th√†nh c√¥ng! ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t trong danh s√°ch.', document.querySelector('.container'));
                
                // Reload danh s√°ch ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i m·ªõi
                setTimeout(() => {
                    loadOrders();
                }, 500);
            } catch (error) {
                console.error('Error confirming order:', error);
                alert('L·ªói: ' + error.message);
            }
        }
        
        function showCompleteModal(orderId) {
            currentOrderId = orderId;
            const info = document.getElementById('completeOrderInfo');
            info.innerHTML = 'ƒêang t·∫£i th√¥ng tin...';
            showModal('completeOrderModal');
            
            // Load order info
            const token = localStorage.getItem('adminToken');
            fetch(`${API_BASE_URL}/api/orders/${orderId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(async res => {
                // Ki·ªÉm tra Content-Type tr∆∞·ªõc khi parse JSON
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    throw new Error('API tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i API endpoint.');
                }
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ error: `L·ªói ${res.status}: ${res.statusText}` }));
                    throw new Error(errorData.error || `L·ªói ${res.status}`);
                }
                
                return res.json();
            })
            .then(order => {
                const orderCode = order.orderCode || order.code || orderId.substring(0, 8).toUpperCase();
                const items = order.items || order.products || [];
                
                // T√≠nh t·ªïng ti·ªÅn t·ª´ items n·∫øu order.total kh√¥ng c√≥
                let calculatedTotal = 0;
                if (items.length > 0) {
                    items.forEach(item => {
                        const quantity = item.quantity || 1;
                        const price = item.price || 0;
                        calculatedTotal += price * quantity;
                    });
                }
                
                // S·ª≠ d·ª•ng finalAmount (sau khi tr·ª´ discount) l√†m t·ªïng ti·ªÅn ch√≠nh
                const finalAmount = order.finalAmount || order.totalAmount || order.total || order.amount || order.price || calculatedTotal;
                const totalAmount = order.totalAmount || order.total || order.amount || order.price || calculatedTotal;
                const discountAmount = order.discountAmount || 0;
                const total = finalAmount;
                const customerName = (order.customer && order.customer.name) || order.customerName || 'N/A';
                
                info.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <p><strong>M√£ ƒë∆°n:</strong> #${orderCode}</p>
                        <p><strong>Kh√°ch h√†ng:</strong> ${customerName}</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-top: 15px;">
                        <p style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.9;">S·ªë ti·ªÅn s·∫Ω ƒë∆∞·ª£c t√≠nh v√†o doanh thu</p>
                        ${discountAmount > 0 ? `
                            <div style="font-size: 14px; opacity: 0.8; text-decoration: line-through; margin-bottom: 5px;">${formatCurrency(totalAmount)}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 8px;">Gi·∫£m: ${formatCurrency(discountAmount)}</div>
                        ` : ''}
                        <div style="font-size: 28px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">${formatCurrency(total)}</div>
                    </div>
                `;
            })
            .catch(err => {
                console.error('Error loading order:', err);
                info.innerHTML = `<p style="color: var(--danger-color);">L·ªói: ${err.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng'}</p>`;
            });
        }
        
        function closeCompleteModal() {
            hideModal('completeOrderModal');
            currentOrderId = null;
        }
        
        async function completeOrderAction() {
            if (!currentOrderId) return;
            
            const token = localStorage.getItem('adminToken');
            try {
                // S·ª≠ d·ª•ng endpoint /api/orders/:id/complete ƒë·ªÉ ho√†n th√†nh ƒë∆°n h√†ng
                const response = await apiCall(`/api/orders/${currentOrderId}/complete`, {
                    method: 'PUT'
                });
                
                // Ki·ªÉm tra k·∫øt qu·∫£
                if (!response.ok) {
                    const contentType = response?.headers?.get('content-type');
                    let errorMessage = 'Kh√¥ng th·ªÉ ho√†n th√†nh ƒë∆°n h√†ng. ';
                    
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            const data = await response.json();
                            errorMessage += data.error || `L·ªói ${response.status}`;
                        } catch (e) {
                            errorMessage += `L·ªói ${response.status}`;
                        }
                    } else {
                        errorMessage += `L·ªói ${response.status}`;
                    }
                    throw new Error(errorMessage);
                }
                
                // ƒê·ªçc response JSON
                const result = await response.json();
                
                closeCompleteModal();
                closeOrderDetail(); // ƒê√≥ng modal chi ti·∫øt n·∫øu ƒëang m·ªü
                showSuccess('üéâ ƒê√£ ho√†n th√†nh ƒë∆°n h√†ng! ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t√≠nh v√†o doanh thu.', document.querySelector('.container'));
                
                // Reload danh s√°ch ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i m·ªõi
                setTimeout(() => {
                    loadOrders();
                }, 500);
            } catch (error) {
                console.error('Error completing order:', error);
                alert('L·ªói: ' + error.message);
            }
        }
        
        function showCancelModal(orderId) {
            currentOrderId = orderId;
            const info = document.getElementById('cancelOrderInfo');
            info.innerHTML = 'ƒêang t·∫£i th√¥ng tin...';
            showModal('cancelOrderModal');
            
            // Load order info
            const token = localStorage.getItem('adminToken');
            fetch(`${API_BASE_URL}/api/orders/${orderId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(async res => {
                // Ki·ªÉm tra Content-Type tr∆∞·ªõc khi parse JSON
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    throw new Error('API tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i API endpoint.');
                }
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ error: `L·ªói ${res.status}: ${res.statusText}` }));
                    throw new Error(errorData.error || `L·ªói ${res.status}`);
                }
                
                return res.json();
            })
            .then(order => {
                const orderCode = order.orderCode || order.code || orderId.substring(0, 8).toUpperCase();
                const items = order.items || order.products || [];
                
                // T√≠nh t·ªïng ti·ªÅn t·ª´ items n·∫øu order.total kh√¥ng c√≥
                let calculatedTotal = 0;
                if (items.length > 0) {
                    items.forEach(item => {
                        const quantity = item.quantity || 1;
                        const price = item.price || 0;
                        calculatedTotal += price * quantity;
                    });
                }
                
                // S·ª≠ d·ª•ng finalAmount (sau khi tr·ª´ discount) l√†m t·ªïng ti·ªÅn ch√≠nh
                const finalAmount = order.finalAmount || order.totalAmount || order.total || order.amount || order.price || calculatedTotal;
                const totalAmount = order.totalAmount || order.total || order.amount || order.price || calculatedTotal;
                const discountAmount = order.discountAmount || 0;
                const total = finalAmount;
                const customerName = (order.customer && order.customer.name) || order.customerName || 'N/A';
                const orderStatus = order.status || order.orderStatus || 'pending';
                
                const statusText = orderStatus === 'pending' ? 'Ch·ªù x·ª≠ l√Ω' :
                                  orderStatus === 'confirmed' ? 'ƒê√£ x√°c nh·∫≠n' :
                                  orderStatus === 'shipping' ? 'ƒêang giao h√†ng' :
                                  orderStatus;
                
                info.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <p><strong>M√£ ƒë∆°n:</strong> #${orderCode}</p>
                        <p><strong>Kh√°ch h√†ng:</strong> ${customerName}</p>
                        <p><strong>Tr·∫°ng th√°i:</strong> ${statusText}</p>
                    </div>
                    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-top: 15px;">
                        <p style="margin: 0 0 10px 0; font-size: 14px; opacity: 0.9;">T·ªïng ti·ªÅn ƒë∆°n h√†ng s·∫Ω b·ªã h·ªßy</p>
                        ${discountAmount > 0 ? `
                            <div style="font-size: 14px; opacity: 0.8; text-decoration: line-through; margin-bottom: 5px;">${formatCurrency(totalAmount)}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 8px;">Gi·∫£m: ${formatCurrency(discountAmount)}</div>
                        ` : ''}
                        <div style="font-size: 28px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">${formatCurrency(total)}</div>
                    </div>
                `;
            })
            .catch(err => {
                console.error('Error loading order:', err);
                info.innerHTML = `<p style="color: var(--danger-color);">L·ªói: ${err.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng'}</p>`;
            });
        }
        
        function closeCancelModal() {
            hideModal('cancelOrderModal');
            currentOrderId = null;
        }
        
        async function cancelOrderAction() {
            if (!currentOrderId) return;
            
            const token = localStorage.getItem('adminToken');
            try {
                // S·ª≠ d·ª•ng endpoint /api/orders/:id/status ƒë·ªÉ h·ªßy ƒë∆°n h√†ng
                const response = await apiCall(`/api/orders/${currentOrderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'cancelled' })
                });
                
                // Ki·ªÉm tra k·∫øt qu·∫£
                if (!response.ok) {
                    const contentType = response?.headers?.get('content-type');
                    let errorMessage = 'Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng. ';
                    
                    if (contentType && contentType.includes('application/json')) {
                        try {
                            const data = await response.json();
                            errorMessage += data.error || `L·ªói ${response.status}`;
                        } catch (e) {
                            errorMessage += `L·ªói ${response.status}`;
                        }
                    } else {
                        errorMessage += `L·ªói ${response.status}`;
                    }
                    throw new Error(errorMessage);
                }
                
                // ƒê·ªçc response JSON
                const result = await response.json();
                
                closeCancelModal();
                closeOrderDetail(); // ƒê√≥ng modal chi ti·∫øt n·∫øu ƒëang m·ªü
                showSuccess('‚ùå ƒê√£ h·ªßy ƒë∆°n h√†ng th√†nh c√¥ng! S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c tr·∫£ l·∫°i kho.', document.querySelector('.container'));
                
                // Reload danh s√°ch ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i m·ªõi
                setTimeout(() => {
                    loadOrders();
                }, 500);
            } catch (error) {
                console.error('Error canceling order:', error);
                alert('L·ªói: ' + error.message);
            }
        }
    </script>
</body>
</html>

